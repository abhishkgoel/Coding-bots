<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentic Wallet Pass Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Agentic Wallet Pass Creator</h1>
            <p class="text-gray-600 mt-2">Let our AI agent read, categorize, and create a smart pass from your receipt.</p>
        </header>

        <main class="bg-white p-6 md:p-8 rounded-2xl shadow-lg space-y-6">
            <div>
                <h2 class="text-xl font-semibold mb-3 text-gray-800">Upload Your Receipt</h2>
                <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center cursor-pointer hover:bg-gray-50 transition" id="drop-zone">
                    <input type="file" id="image-upload" class="hidden" accept="image/*">
                    <div id="upload-prompt">
                         <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                        <p class="mt-2 text-sm text-gray-600"><span class="font-semibold text-indigo-600">Click to upload</span> or drag and drop</p>
                        <p class="text-xs text-gray-500">PNG, JPG, GIF up to 10MB</p>
                    </div>
                    <div id="image-preview-container" class="hidden">
                        <img id="image-preview" class="max-h-64 mx-auto rounded-lg shadow-md" alt="Image preview"/>
                        <p id="image-name" class="mt-2 text-sm font-medium text-gray-700"></p>
                    </div>
                </div>
                 <button id="create-pass-button" class="mt-4 w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center" disabled>
                    <svg id="scan-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M7 21H5a2 2 0 0 1-2-2v-2m18-2v2a2 2 0 0 1-2 2h-2m-8-18H5a2 2 0 0 0-2 2v2m18 0V5a2 2 0 0 0-2-2h-2"/></svg>
                    <span id="button-text">Create Wallet Pass</span>
                </button>
            </div>

            <div id="loader" class="hidden flex justify-center items-center space-x-3">
                <div class="loader"></div>
                <span id="loader-text" class="text-gray-600">ðŸ¤– Agent is thinking...</span>
            </div>

            <div id="results-section" class="hidden text-center p-4 bg-green-50 border border-green-200 rounded-lg">
                <h2 class="text-xl font-semibold text-green-800">Success!</h2>
                <p class="text-green-700 mt-2">Your smart pass has been created. Your browser should now open a new tab to add it to Google Wallet.</p>
                <a id="save-link" href="#" target="_blank" class="mt-4 inline-block bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Open Link Manually</a>
            </div>
        </main>
    </div>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const imageUpload = document.getElementById('image-upload');
        const uploadPrompt = document.getElementById('upload-prompt');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const imageName = document.getElementById('image-name');
        const createPassButton = document.getElementById('create-pass-button');
        const loader = document.getElementById('loader');
        const resultsSection = document.getElementById('results-section');
        const saveLink = document.getElementById('save-link');

        let uploadedFile = null;

        // --- Event Handlers ---
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-indigo-600', 'bg-indigo-50'); });
        dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('border-indigo-600', 'bg-indigo-50'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-indigo-600', 'bg-indigo-50');
            if (e.dataTransfer.files.length > 0) handleImageUpload(e.dataTransfer.files[0]);
        });
        dropZone.addEventListener('click', () => imageUpload.click());
        imageUpload.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleImageUpload(e.target.files[0]);
        });

        function handleImageUpload(file) {
            if (file && file.type.startsWith('image/')) {
                uploadedFile = file;
                imagePreview.src = URL.createObjectURL(file);
                uploadPrompt.classList.add('hidden');
                imagePreviewContainer.classList.remove('hidden');
                imageName.textContent = file.name;
                createPassButton.disabled = false;
                resultsSection.classList.add('hidden');
            }
        }

        // --- Main Application Logic ---
        createPassButton.addEventListener('click', async () => {
            if (!uploadedFile) return;

            loader.classList.remove('hidden');
            resultsSection.classList.add('hidden');
            createPassButton.disabled = true;

            try {
                // The frontend now only needs to send the image file.
                // The backend agent handles all the complex logic.
                const formData = new FormData();
                formData.append('receiptImage', uploadedFile);

                const response = await fetch('http://127.0.0.1:5001/create-agentic-pass', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Server processing failed: ${errorData.error || 'Unknown error'}`);
                }

                const result = await response.json();

                // Show success and open the link
                saveLink.href = result.saveUrl;
                resultsSection.classList.remove('hidden');
                window.open(result.saveUrl, '_blank');

            } catch (error) {
                console.error('Error during pass creation:', error);
                alert('An error occurred: ' + error.message);
            } finally {
                loader.classList.add('hidden');
                createPassButton.disabled = false;
            }
        });
    </script>
</body>
</html>
